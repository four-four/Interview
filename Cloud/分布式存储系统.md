##定义
分布式存储系统是大量普通PC通过Internet互联，对外作为第一个整体提供存储服务。

##数据类型分类
- 非结构化数据，一般的文档
- 结构化数据，存储在关系型数据库中
- 半结构化数据，HTML文档

##分布式存储系统分类

###分布式文件系统
- 非结构化数据，以对象的形式组织，对象之间没有关联，称为Blob（二进制大对象）数据
- Facebook Haystack 以及 Taobao File System
- 常作为分布式表格系统以及分布式数据库的底层存储 （GFS - Google Bigtable/ EBS - Amazon RDS)
- 存储类型：Blob对象、定长块、大文件

###分布式键值系统
- 较简单的半结构化数据，只提供主键的CRUD。
- Amazon Dynamo 以及 Taobao Tair

###分布式表格系统
- 较复杂的半结构化数据，不支持CRDU，支持扫描某个主键范围
- 以表格为单位组织数据，每个表格包括很多行，通过主键标识一行，支持根据主键的CRUD功能以及范围查找内容
- Google Bigtable, Microsoft Azre Table Storage, Amazon DynamoDB

###分布式数据库
- 存储结构化数据，一般是由单机关系数据库扩展而来
- MySQL数据库分片集群，Amazon RDS, Microsoft SQL Azure

##分布式系统解决的问题
- 单机存储的性能问题
- 单点故障问题
- 容量

##设计分布式系统需要考虑的问题
- 可扩展性（已解决，通过数据分片）
- 数据分片解决了部分性能问题，解决性能问题的方法还有复制
- 解决单点故障问题的唯一手段是复制
- 复制会带来一致性问题

##基础结构
一般分为两到三层
- 最底层分布式文件系统，解决数据分块，复制，读写等需求
- 往上是数据结构层，解决数据模型，CAP取舍等（Consistency一致性/Availability可用性/Partition Tolenrance分区容忍性）
- 再往上是更高层API，解决诸如事物等问题

###数据分布策略
####哈希分布
- 一致性哈希
  - 一种特殊的哈希算法，对服务器和数据分别进行2^32取模，把数据放入顺时针离数据最近的第一台服务器中。
  - 会有数据倾斜问题，解决方法是设置虚拟节点，以及虚拟节点到实际节点的映射。
####顺序分布

###一致性策略
- 强一致性：复制是同步的，A先写入了一个值，后续A，B，C的读取操作都将返回最新值。
- 弱一致性：复制是异步的，有一个一致性窗口，在A写入一个值后，过一段时间A，B，C都会读取到这个最新值。
  - 最终一致性：所有的数据库里的数据最终都会达到一致。
  - 读写一致性：
    - 对于某些特定的内容，都从主库读
    - 记录主数据库的更新时间，监控从库的最后同步时间，从库更新了，就从从库读，没更新从主库读。
  - 单调读：确保每个用户总是从同一个节点进行读取。
  - 因果一致性：假如A与B是有因果关系的，则保证B读取的数据一定是A更新以后的，与A没有关系的C则可以使用最终一致性策略。

###故障监控策略
- 租约：在一定时间内给特定权力的协议，根据协议内容的不同实现不同的功能
  - 协议内容是确认客户端还活着 -- 心跳
  - 协议内容是保证内容不会被修改 -- 读锁
  - 协议内容是保证内容只有当前客户端修改 -- 写锁
- 心跳 ： 类似keepalive，但有可能会因为网络问题而没有收到心跳信息而出现”双主“问题
  - 单向的
  - 双向的

###集群管理策略
- 主控，Paxos协议
- 点对点

###分布式事务策略
- 两阶段提交协议

###数据模型
- 表
- kv
- 文档
- 列族
- 图

###查询方式
- SQL
- 主键
- path
- 索引
- 聚合

###CAP理论
当分布式存储网络中有一台机器断开连接了，但它与客户的连接还在，当客户发送读写请求：
- 返回本机上存储的结果：牺牲了C，保证了AP
- 告诉客户无法完成请求：牺牲了P，保证了AC
- 一直等待网络恢复连接：牺牲了A，保证了CP

###向量时钟
获取任意两个事件的时间顺序

###NWR
用于控制一致性级别的策略。
N - 同一份数据的Replica数。
W - 更新一份数据对象需要确保更新成功的份数。
R - 读取一份数据需要读取的Replica数。

- R == N 或者 W == N，强一致性，弱可用性。
- W + R < N，强可用性，弱一致性。
- W < N , R < N , W + R > N，均衡的可用性和一致性。
- W + R > N， 保证某个数据不被两个不同的事务同时读和写。
- W > N / 2，保证两个事务不能并发写某一个数据。

